<script>
<%content_for :global do %>
  var colorBuffer, vertexBuffer;
  var camera = new Camera({lock_y_axis:true});
  var heightMap;

  function initTextures() {  
    var grass = gl.createTexture();  
    var img = new Image();  
    img.onload = function() { handleTextureLoaded(img, grass); };  
    img.src = "http://localhost/~colin/rails-game/images/textures/poormansgrass.png";  
  }  
      
  function handleTextureLoaded(image, texture) {
    try {
      gl.bindTexture(gl.TEXTURE_2D, texture);  
      gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);
      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);  
      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR_MIPMAP_NEAREST);  
      gl.generateMipmap(gl.TEXTURE_2D);  
      gl.bindTexture(gl.TEXTURE_2D, null);
        
      heightMap.addTexture(texture, {scale:3});
    } catch(e) { alert(e+"\n\n"+e.stack); }
  }  
    
  function updateKeyboardInput()
  {
    var rotation = [0,0,0];
    var translation = [0,0,0];
    var movement_speed = 1.5; // in GL units per second
    var rotation_speed = 0.5;
    var strafing_speed = 1.0;
      
    movement_speed *= 0.75; // because that's the delay between frames (via setInterval, above)
    rotation_speed *= 0.15; // in an offline app we'd calculate time elapsed between frames.
    strafing_speed *= 0.15;
      
    if (currentlyPressedKeys[37]) rotation[1] -= rotation_speed; // arrow left
    if (currentlyPressedKeys[39]) rotation[1] += rotation_speed; // arrow right
    if (currentlyPressedKeys[38]) rotation[0] += rotation_speed; // arrow up
    if (currentlyPressedKeys[40]) rotation[0] -= rotation_speed; // arrow down
    if (currentlyPressedKeys[87]) translation[2] -= 1; // W
    if (currentlyPressedKeys[83]) translation[2] += 1; // S
    if (currentlyPressedKeys[65]) translation[0] -= 1; // A
    if (currentlyPressedKeys[68]) translation[0] += 1; // D
      
    camera.move(movement_speed, translation);
    //camera.rotateView(rotation[0], rotation[1], 0);
  }
<%end%>

<%content_for :init do%>
  var img = new Image();
  img.onload = function() {
    heightMap = new HeightMap(gl, img, {magnitude:4});
    checkGLError();
    initTextures();
    checkGLError();
  };
  img.src = "http://localhost/~colin/rails-game/images/height.png";

  camera.moveTo(35, 75, 42);
  camera.orient([0, -1, -0.2], [0, 0.2, -1]).look();
      
  setInterval(updateKeyboardInput, 15);
<%end%>

<%content_for :render do%>
  if (!heightMap) return;
  camera.look(gl);
  
  heightMap.render();
<%end%>
</script>
